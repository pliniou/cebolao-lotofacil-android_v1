package com.cebolao.lotofacil.ui.screens

import androidx.compose.animation.AnimatedContent
import androidx.compose.animation.animateColorAsState
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.ExperimentalLayoutApi
import androidx.compose.foundation.layout.FlowRow
import androidx.compose.foundation.layout.PaddingValues
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.WindowInsets
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.statusBars
import androidx.compose.foundation.layout.windowInsetsPadding
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.LazyRow
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.CloudOff
import androidx.compose.material.icons.filled.HourglassEmpty
import androidx.compose.material.icons.filled.Info
import androidx.compose.material.icons.filled.LocalFireDepartment
import androidx.compose.material.icons.filled.Refresh
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.CircularProgressIndicator
import androidx.compose.material3.FilterChip
import androidx.compose.material3.FilterChipDefaults
import androidx.compose.material3.HorizontalDivider
import androidx.compose.material3.Icon
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Scaffold
import androidx.compose.material3.SnackbarDuration
import androidx.compose.material3.SnackbarHost
import androidx.compose.material3.SnackbarHostState
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.getValue
import androidx.compose.runtime.remember
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.res.stringResource
import androidx.compose.ui.text.SpanStyle
import androidx.compose.ui.text.buildAnnotatedString
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.text.withStyle
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import androidx.lifecycle.compose.collectAsStateWithLifecycle
import com.cebolao.lotofacil.R
import com.cebolao.lotofacil.data.StatisticsReport
import com.cebolao.lotofacil.domain.model.LastDrawStats
import com.cebolao.lotofacil.ui.components.AnimateOnEntry
import com.cebolao.lotofacil.ui.components.AppCard
import com.cebolao.lotofacil.ui.components.BarChart
import com.cebolao.lotofacil.ui.components.ClickableCard
import com.cebolao.lotofacil.ui.components.NumberBall
import com.cebolao.lotofacil.ui.components.NumberBallVariant
import com.cebolao.lotofacil.ui.components.OptimizedNumberBall
import com.cebolao.lotofacil.ui.components.StandardScreenHeader
import com.cebolao.lotofacil.ui.components.StatCard
import com.cebolao.lotofacil.ui.components.shimmer
import com.cebolao.lotofacil.ui.screens.home.LastDrawSection
import com.cebolao.lotofacil.ui.screens.home.StatisticsExplanationCard
import com.cebolao.lotofacil.ui.screens.home.StatisticsSection
import com.cebolao.lotofacil.ui.theme.AppCardDefaults
import com.cebolao.lotofacil.ui.theme.AppSpacing
import com.cebolao.lotofacil.ui.theme.DesignSystem
import com.cebolao.lotofacil.viewmodels.HomeUiState
import com.cebolao.lotofacil.viewmodels.HomeViewModel
import com.cebolao.lotofacil.viewmodels.StatChipValues
import com.cebolao.lotofacil.viewmodels.StatisticPattern
import com.cebolao.lotofacil.navigation.UiEvent
import kotlinx.collections.immutable.toImmutableList

@Composable
fun HomeScreen(homeViewModel: HomeViewModel = hiltViewModel()) {
    val uiState by homeViewModel.uiState.collectAsStateWithLifecycle()
    val snackbarHostState = remember { SnackbarHostState() }

    LaunchedEffect(Unit) {
        homeViewModel.uiEvent.collect { event ->
            when (event) {
                is UiEvent.ShowSnackbar -> {
                    snackbarHostState.showSnackbar(
                        message = event.message,
                        actionLabel = event.actionLabel,
                        duration = SnackbarDuration.Long
                    )
                }
                else -> {}
            }
        }
    }

    Scaffold(
        snackbarHost = { SnackbarHost(snackbarHostState) },
        modifier = Modifier.fillMaxSize()
    ) { innerPadding ->
        LazyColumn(
            modifier = Modifier
                .fillMaxSize()
                .padding(innerPadding)
                .windowInsetsPadding(WindowInsets.statusBars),
            contentPadding = PaddingValues(
                bottom = AppSpacing.xxxl
            ),
            verticalArrangement = Arrangement.spacedBy(AppSpacing.xl)
        ) {
            item(key = "header") {
                StandardScreenHeader(
                    title = stringResource(id = R.string.cebolao_title),
                    subtitle = stringResource(id = R.string.lotofacil_subtitle),
                    iconPainter = painterResource(id = R.drawable.ic_lotofacil_logo)
                )
            }
            if (uiState.isScreenLoading) {
                item(key = "skeleton") { HomeScreenSkeleton() }
            } else if (uiState.errorMessageResId != null) {
                item(key = "error") {
                    ErrorState(
                        messageResId = uiState.errorMessageResId!!,
                        onRetry = { homeViewModel.retryInitialLoad() }
                    )
                }
            } else {
                item(key = "last_draw") {
                    uiState.lastDrawStats?.let { stats ->
                        AnimateOnEntry(delayMillis = 100L) {
                            LastDrawSection(stats)
                        }
                    }
                }
                item(key = "statistics") {
                    AnimateOnEntry(delayMillis = 200L) {
                        StatisticsSection(
                            stats = uiState.statistics,
                            isStatsLoading = uiState.isStatsLoading,
                            selectedTimeWindow = uiState.selectedTimeWindow,
                            selectedPattern = uiState.selectedPattern,
                            onTimeWindowSelected = { homeViewModel.onTimeWindowSelected(it) },
                            onPatternSelected = { homeViewModel.onPatternSelected(it) }
                        )
                    }
                }
                item(key = "explanation") {
                    AnimateOnEntry(delayMillis = 300L) {
                        StatisticsExplanationCard()
                    }
                }
            }
        }
    }
}

@Composable
private fun SuccessState(
    state: HomeUiState,
    onTimeWindowSelected: (Int) -> Unit,
    onPatternSelected: (StatisticPattern) -> Unit
) {
    Column(
        modifier = Modifier.padding(horizontal = AppSpacing.lg),
        verticalArrangement = Arrangement.spacedBy(AppSpacing.xxl)
    ) {
private fun LastDrawSection(stats: LastDrawStats) {
    AppCard(
        modifier = Modifier.fillMaxWidth(),
        elevation = AppCardDefaults.elevation
    ) {
        Column(
            Modifier.padding(AppCardDefaults.defaultPadding), 
            verticalArrangement = Arrangement.spacedBy(AppCardDefaults.contentSpacing)
        ) {
            Text(
                "${stringResource(id = R.string.last_contest)}: #${stats.contest}",
                style = MaterialTheme.typography.titleMedium
            )
            val sortedNumbers = remember(stats.numbers) { stats.numbers.sorted() }
            FlowRow(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.spacedBy(AppSpacing.sm, Alignment.CenterHorizontally),
                verticalArrangement = Arrangement.spacedBy(AppSpacing.sm),
                maxItemsInEachRow = 5
            ) {
                sortedNumbers.forEach {
                    OptimizedNumberBall(it, size = 40.dp, variant = NumberBallVariant.Lotofacil)
                }
            }
            HorizontalDivider(color = MaterialTheme.colorScheme.outline.copy(alpha = 0.1f))
            FlowRow(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.spacedBy(AppSpacing.md, Alignment.CenterHorizontally),
                verticalArrangement = Arrangement.spacedBy(AppSpacing.md)
            ) {
                StatChip(stringResource(id = R.string.sum_label), stats.sum.toString())
                StatChip(stringResource(id = R.string.even_label), stats.evens.toString())
                StatChip(stringResource(id = R.string.prime_label), stats.primes.toString())
                StatChip(stringResource(id = R.string.frame_label), stats.frame.toString())
                StatChip(stringResource(id = R.string.portrait_label), stats.portrait.toString())
                StatChip(stringResource(id = R.string.fibonacci_label), stats.fibonacci.toString())
            }
        }
    }
}

@Composable
private fun StatChip(label: String, value: String) {
    Column(horizontalAlignment = Alignment.CenterHorizontally) {
        Text(
            text = value,
            style = MaterialTheme.typography.titleMedium,
            fontWeight = FontWeight.Bold,
            color = MaterialTheme.colorScheme.primary
        )
        Text(label, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant)
    }
}

@Composable
private fun StatisticsSection(
    stats: StatisticsReport?,
    isStatsLoading: Boolean,
    selectedTimeWindow: Int,
    selectedPattern: StatisticPattern,
    onTimeWindowSelected: (Int) -> Unit,
    onPatternSelected: (StatisticPattern) -> Unit
) {
    Column(verticalArrangement = Arrangement.spacedBy(AppCardDefaults.contentSpacing)) {
        Text(stringResource(id = R.string.statistics_center), style = MaterialTheme.typography.headlineSmall)
        stats?.let {
            AppCard(
                modifier = Modifier.fillMaxWidth(),
                elevation = AppCardDefaults.elevation
            ) {
                Column(
                    Modifier.padding(vertical = AppCardDefaults.defaultPadding),
                    verticalArrangement = Arrangement.spacedBy(AppCardDefaults.contentSpacing)
                ) {
                    StatRow(stringResource(id = R.string.most_delayed_numbers), it.mostOverdueNumbers, Icons.Default.HourglassEmpty, stringResource(id = R.string.delayed_suffix))
                    HorizontalDivider(color = MaterialTheme.colorScheme.outline.copy(alpha = 0.1f))
                    TimeWindowSelector(selectedTimeWindow, onTimeWindowSelected)
                    AnimatedContent(isStatsLoading, label = "stats") { loading ->
                        if (loading) {
                            StatsLoadingSkeleton()
                        } else {
                            Column(verticalArrangement = Arrangement.spacedBy(AppCardDefaults.contentSpacing)) {
                                StatRow(stringResource(id = R.string.most_drawn_numbers), it.mostFrequentNumbers, Icons.Default.LocalFireDepartment, stringResource(id = R.string.frequency_suffix))
                                HorizontalDivider(color = MaterialTheme.colorScheme.outline.copy(alpha = 0.1f))
                                DistributionCharts(it, selectedPattern, onPatternSelected)
                            }
                        }
                    }
                }
            }
        }
    }
}

@Composable
private fun StatisticsExplanationCard() {
    Column(verticalArrangement = Arrangement.spacedBy(AppCardDefaults.contentSpacing)) {
        Text(stringResource(id = R.string.understanding_statistics), style = MaterialTheme.typography.headlineSmall)
        AppCard(
            modifier = Modifier.fillMaxWidth(),
            elevation = AppCardDefaults.elevation,
            border = BorderStroke(1.dp, MaterialTheme.colorScheme.primaryContainer)
        ) {
            Column(
                modifier = Modifier.padding(AppCardDefaults.defaultPadding),
                verticalArrangement = Arrangement.spacedBy(AppSpacing.sm)
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically, 
                    horizontalArrangement = Arrangement.spacedBy(AppSpacing.sm)
                ) {
                    Icon(
                        Icons.Default.Info, 
                        contentDescription = null, 
                        tint = MaterialTheme.colorScheme.primary,
                        modifier = Modifier.size(iconMedium())
                    )
                    Text(stringResource(id = R.string.how_to_read_data), style = MaterialTheme.typography.titleMedium)
                }
                HorizontalDivider(color = MaterialTheme.colorScheme.outline.copy(alpha = 0.1f))
                Text(
                    buildAnnotatedString {
                        withStyle(style = SpanStyle(fontWeight = FontWeight.Bold)) {
                            append("• Dezenas Atrasadas/Sorteadas: ")
                        }
                        append("Mostram os 5 números mais 'frios' (sem sair) e 'quentes' (mais frequentes). O valor abaixo indica o atraso (em concursos) ou a frequência total.")
                    },
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                Text(
                    buildAnnotatedString {
                        withStyle(style = SpanStyle(fontWeight = FontWeight.Bold)) {
                            append("• Gráficos de Distribuição: ")
                        }
                        append("A barra mais alta indica a ocorrência mais comum de um padrão (ex: 8 números pares). Use os filtros acima do gráfico para explorar diferentes estatísticas.")
                    },
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            }
        }
    }
}

@Composable
private fun TimeWindowSelector(selected: Int, onSelect: (Int) -> Unit) {
    val windows = listOf(0, 500, 250, 100, 50, 10)
    Column(Modifier.padding(horizontal = AppSpacing.lg), verticalArrangement = Arrangement.spacedBy(AppSpacing.md)) {
        Text("Período de Análise", style = MaterialTheme.typography.titleMedium)
        LazyRow(horizontalArrangement = Arrangement.spacedBy(AppSpacing.md)) {
            items(windows, key = { it }) { window ->
                TimeWindowChip(
                    isSelected = window == selected,
                    onClick = { onSelect(window) },
                    label = if (window == 0) "Todos" else "Últimos $window"
                )
            }
        }
    }
}

@Composable
private fun TimeWindowChip(isSelected: Boolean, onClick: () -> Unit, label: String) {
    val container by animateColorAsState(
        if (isSelected) MaterialTheme.colorScheme.primaryContainer else MaterialTheme.colorScheme.surface,
        label = "chipContainer"
    )
    val content by animateColorAsState(
        if (isSelected) MaterialTheme.colorScheme.onPrimaryContainer else MaterialTheme.colorScheme.onSurfaceVariant,
        label = "chipContent"
    )
    ClickableCard(
        onClick = onClick,
        shape = MaterialTheme.shapes.medium,
        backgroundColor = container,
        border = if (!isSelected) BorderStroke(1.dp, MaterialTheme.colorScheme.outline.copy(alpha = 0.3f)) else null
    ) {
        Text(
            label,
            style = MaterialTheme.typography.labelLarge,
            color = content,
            modifier = Modifier.padding(horizontal = AppSpacing.md, vertical = AppSpacing.sm)
        )
    }
}

@Composable
private fun StatRow(title: String, numbers: List<Pair<Int, Int>>, icon: ImageVector, suffix: String) {
    Column(Modifier.padding(horizontal = 16.dp), verticalArrangement = Arrangement.spacedBy(12.dp)) {
        Row(verticalAlignment = Alignment.CenterVertically, horizontalArrangement = Arrangement.spacedBy(8.dp)) {
            Icon(icon, null, tint = MaterialTheme.colorScheme.primary)
            Text(title, style = MaterialTheme.typography.titleMedium)
        }
        Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceEvenly) {
            numbers.forEach { (num, value) ->
                Column(horizontalAlignment = Alignment.CenterHorizontally, verticalArrangement = Arrangement.spacedBy(4.dp)) {
                    OptimizedNumberBall(num, size = 40.dp)
                    Text("$value$suffix", style = MaterialTheme.typography.bodySmall)
                }
            }
        }
    }
}

@Composable
private fun DistributionCharts(
    stats: StatisticsReport,
    selected: StatisticPattern,
    onSelect: (StatisticPattern) -> Unit
) {
    val patterns = remember { StatisticPattern.entries.toTypedArray() }
    Column(verticalArrangement = Arrangement.spacedBy(AppSpacing.md)) {
        LazyRow(contentPadding = PaddingValues(horizontal = AppSpacing.lg), horizontalArrangement = Arrangement.spacedBy(AppSpacing.md)) {
            items(patterns, key = { it.name }) { pattern ->
                val selectedPattern = selected == pattern
                FilterChip(
                    selected = selectedPattern,
                    onClick = { onSelect(pattern) },
                    label = { Text(stringResource(id = pattern.titleRes)) },
                    leadingIcon = { Icon(pattern.icon, null, Modifier.size(FilterChipDefaults.IconSize)) }
                )
            }
        }
        val data = remember(selected, stats) {
            when (selected) {
                StatisticPattern.SUM -> stats.sumDistribution
                StatisticPattern.EVENS -> stats.evenDistribution
                StatisticPattern.PRIMES -> stats.primeDistribution
                StatisticPattern.FRAME -> stats.frameDistribution
                StatisticPattern.PORTRAIT -> stats.portraitDistribution
                StatisticPattern.FIBONACCI -> stats.fibonacciDistribution
                StatisticPattern.MULTIPLES_OF_3 -> stats.multiplesOf3Distribution
            }.toList().sortedBy { it.first }.map { it.first.toString() to it.second }.toImmutableList()
        }
        val max = remember(data) { (data.maxOfOrNull { it.second } ?: 1) }
        AnimatedContent(data, label = "chart") { list ->
            if (list.isNotEmpty()) {
                BarChart(
                    data = list,
                    maxValue = max,
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(horizontal = 16.dp)
                )
            }
        }
    }
}

@Composable
private fun HomeScreenSkeleton() {
    Column(
        modifier = Modifier.padding(horizontal = AppSpacing.lg),
        verticalArrangement = Arrangement.spacedBy(AppSpacing.xxl)
    ) {
        // Last Draw Skeleton
        AppCard(modifier = Modifier.fillMaxWidth()) {
            Column(
                Modifier.padding(AppCardDefaults.defaultPadding),
                verticalArrangement = Arrangement.spacedBy(AppSpacing.md)
            ) {
                Box(Modifier.size(150.dp, 20.dp).clip(MaterialTheme.shapes.small).shimmer())
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceEvenly
                ) {
                    repeat(5) {
                        Box(Modifier.size(40.dp).clip(CircleShape).shimmer())
                    }
                }
                Box(Modifier.fillMaxWidth().height(1.dp).background(MaterialTheme.colorScheme.outline.copy(alpha = 0.1f)))
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.spacedBy(AppSpacing.md, Alignment.CenterHorizontally)
                ) {
                    repeat(3) {
                        Box(Modifier.size(60.dp, 30.dp).clip(MaterialTheme.shapes.small).shimmer())
                    }
                }
            }
        }

        // Statistics Skeleton
        Column(verticalArrangement = Arrangement.spacedBy(AppSpacing.md)) {
            Box(Modifier.size(200.dp, 28.dp).clip(MaterialTheme.shapes.small).shimmer())
            AppCard(modifier = Modifier.fillMaxWidth()) {
                Column(
                    Modifier.padding(vertical = AppCardDefaults.defaultPadding),
                    verticalArrangement = Arrangement.spacedBy(AppCardDefaults.contentSpacing)
                ) {
                    repeat(2) {
                        Column(Modifier.padding(horizontal = 16.dp), verticalArrangement = Arrangement.spacedBy(12.dp)) {
                            Box(Modifier.size(150.dp, 20.dp).clip(MaterialTheme.shapes.small).shimmer())
                            Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceEvenly) {
                                repeat(5) {
                                    Box(Modifier.size(40.dp).clip(CircleShape).shimmer())
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}

@Composable
private fun LoadingState() {
    // Mantido por compatibilidade, mas substituído por HomeScreenSkeleton na UI principal
    Box(
        Modifier
            .fillMaxWidth()
            .height(400.dp),
        contentAlignment = Alignment.Center
    ) {
        CircularProgressIndicator()
    }
}

@Composable
private fun ErrorState(messageResId: Int, onRetry: () -> Unit) {
    AppCard(
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = AppSpacing.lg),
        backgroundColor = MaterialTheme.colorScheme.errorContainer
    ) {
        Column(
            Modifier.padding(AppCardDefaults.defaultPadding),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.spacedBy(AppCardDefaults.contentSpacing)
        ) {
            Icon(
                Icons.Default.CloudOff, 
                null, 
                Modifier.size(iconExtraLarge()), 
                tint = MaterialTheme.colorScheme.error
            )
            Text(
                "Falha ao Carregar Dados", 
                style = MaterialTheme.typography.titleLarge, 
                color = MaterialTheme.colorScheme.onErrorContainer
            )
            Text(stringResource(messageResId), style = MaterialTheme.typography.bodyMedium, color = MaterialTheme.colorScheme.onErrorContainer, textAlign = TextAlign.Center)
            Button(onClick = onRetry) {
                Icon(Icons.Default.Refresh, null)
                Spacer(Modifier.size(ButtonDefaults.IconSpacing))
                Text("Tentar Novamente")
            }
        }
    }
}

@Composable
private fun StatsLoadingSkeleton() {
    Column(
        modifier = Modifier.padding(vertical = AppSpacing.sm),
        verticalArrangement = Arrangement.spacedBy(AppSpacing.lg)
    ) {
        Column(Modifier.padding(horizontal = 16.dp), verticalArrangement = Arrangement.spacedBy(12.dp)) {
            Box(Modifier.size(150.dp, 20.dp).clip(MaterialTheme.shapes.small).shimmer())
            Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceEvenly) {
                repeat(5) {
                    Box(Modifier.size(40.dp).clip(CircleShape).shimmer())
                }
            }
        }
        HorizontalDivider(color = MaterialTheme.colorScheme.outline.copy(alpha = 0.1f))
        Column(Modifier.padding(horizontal = 16.dp), verticalArrangement = Arrangement.spacedBy(16.dp)) {
            Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {
                repeat(4) {
                    Box(Modifier.size(80.dp, 32.dp).clip(MaterialTheme.shapes.medium).shimmer())
                }
            }
            Box(Modifier.fillMaxWidth().height(150.dp).clip(MaterialTheme.shapes.medium).shimmer())
        }
    }
}